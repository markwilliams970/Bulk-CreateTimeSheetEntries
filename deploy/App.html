<!DOCTYPE html>
<html>
<head>
    <title>Rally-CreateTimeSheetEntries</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"iterationChooser",padding:"10px",layout:"hbox"},{xtype:"container",itemId:"includeComplete",padding:"10px",layout:"vbox"},{xtype:"container",itemId:"gridContainer",padding:"10px"}],_iterationCombobox:null,_includeCompletedTasks:null,_currentUser:null,_currentProject:null,_getTasksButton:null,_typeFeature:null,_taskGrid:null,launch:function(){var me=this,currentContext=me.getContext();me._currentUser=currentContext.getUser(),me._currentProject=currentContext.getProject(),me._buildUI()},_buildUI:function(){var me=this;me._iterationCombobox=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:"350px",listeners:{scope:this,select:me._getTasks}}),me.down("#iterationChooser").add(me._iterationCombobox),me._includeCompletedTasks=Ext.create("Rally.ui.CheckboxField",{fieldLabel:"Include Tasks where State = Completed",value:!1,width:"200px"}),me.down("#includeComplete").add(me._includeCompletedTasks),me._getTasksButton=Ext.create("Rally.ui.Button",{text:"Get My Tasks",handler:function(){me._getTasks()}}),me.down("#iterationChooser").add(me._getTasksButton)},_getTasks:function(){var me=this,selectedIteration=this._iterationCombobox.getValue(),selectedIterationRef=Ext.create("Rally.util.Ref",selectedIteration),selectedIterationObjectID=selectedIterationRef.getOid(),currentUserName=me._currentUser.UserName,currentProjectObjectID=me._currentProject.ObjectID;this._taskGrid&&this._taskGrid.destroy();var includeComplete=!1;includeComplete=me._includeCompletedTasks.getValue();var noneFoundMessage="No Tasks owned by you found for the current Project and selected Iteration.",taskFilters=[{property:"Iteration.ObjectID",operator:"=",value:selectedIterationObjectID},{property:"Project.ObjectID",operator:"=",value:currentProjectObjectID},{property:"Owner.UserName",operator:"=",value:currentUserName}];includeComplete===!1&&(taskFilters.push({property:"State",operator:"<",value:"Completed"}),noneFoundMessage="No Tasks owned by you where State < Completed were found for the current Project and selected Iteration."),this._taskGrid=this.down("#gridContainer").add({xtype:"rallygrid",itemId:"rallygrid",columnCfgs:["FormattedID","Name","Project","State","Owner","Iteration"],context:this.getContext(),enableBulkEdit:!0,showRowActionsColumn:!0,storeConfig:{model:"Task",filters:taskFilters,listeners:{load:function(store,data,success){0===data.length&&Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Tasks Not Found",message:noneFoundMessage,confirmLabel:"Ok",listeners:{confirm:function(){}}})}}}})}});
                Ext.override(Rally.ui.menu.bulk.RecordMenu,{items:[{xtype:"rallyrecordmenuitembulkcreatetimesheetentries"}]}),Ext.override(Rally.ui.menu.bulk.MenuItem,{successfulRecordsDueToNoChange:[],successfulRecords:[],dataToUpdate:[],saveRecords:function(records,args,selectedDate){var me=this;me.successfulRecords=[],me.successfulRecordsDueToNoChange=[],me.dataToUpdate=[];var hydratedRecords=[],promises=[];Ext.Array.each(records,function(artifact){promises.push(me.hydrateArtifact(artifact,me))}),Deft.Promise.all(promises).then({success:function(hydratedRecords){var unsuccessfulRecords=[],successfulRecords=me.processRecords(hydratedRecords,args,selectedDate);me.successfulRecordsDueToNoChange=successfulRecords,me.onSuccess(successfulRecords,unsuccessfulRecords,args,"successful update"),Ext.callback(me.onActionComplete,null,[successfulRecords,unsuccessfulRecords])}})},hydrateArtifact:function(artifact,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,artifactType=artifact.get("_type"),artifactOid=artifact.get("ObjectID"),artifactModel=Rally.data.ModelFactory.getModel({type:artifactType,scope:me,success:function(model,operation){model.load(artifactOid,{scope:me,success:function(artifactHydrated,operation){deferred.resolve(artifactHydrated)}})}});return deferred}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("CreateTimeSheetEntries.RecordMenuItemAddToTimesheet",{extend:"Rally.ui.menu.bulk.MenuItem",alias:"widget.rallyrecordmenuitembulkcreatetimesheetentries",clientMetrics:[{beginMethod:"_onAddToTimesheetClicked",endMethod:"onSuccess",description:"bulk action complete"}],_selectDateChooserDialog:null,config:{text:"Add to Timesheet...",handler:function(){this._onAddToTimesheetClicked()},predicate:function(records){return _.every(records,function(record){return record.self.isArtifact()})},processRecords:function(records,args,selectedDate){var me=this,successfulRecords=[],curr=new Date,weekStart=me._calculateWeekStart(selectedDate),weekStartUTC=new Date(weekStart.getTime()-6e4*weekStart.getTimezoneOffset());return _.each(records,function(record){var taskRecord=record,workProduct=record.get("WorkProduct"),workProductrefString=workProduct._ref,workProductRef=Ext.create("Rally.util.Ref",workProductrefString),workProductOID=workProductRef.getOid(),taskOID=record.get("ObjectID"),taskRef=record.get("_ref"),owner=record.get("Owner"),ownerRefString=owner._ref,ownerRef=Ext.create("Rally.util.Ref",ownerRefString),ownerOID=ownerRef.getOid(),project=record.get("Project"),projectRefString=project._ref,projectRef=Ext.create("Rally.util.Ref",projectRefString),projectOID=projectRef.getOid(),timeSheetEntry={Project:projectRefString,WorkProduct:workProductrefString,Task:taskRef,User:ownerRefString,WeekStartDate:weekStartUTC.toISOString()},newTimeSheetModel=Rally.data.ModelFactory.getModel({type:"TimeEntryItem"}).then({success:function(model){var record=Ext.create(model,timeSheetEntry);record.save(),successfulRecords.push(taskRecord)}});successfulRecords.push(record)}),successfulRecords},callingScope:this},constructor:function(config){this.mergeConfig(config),this.callParent(arguments)},_calculateWeekStart:function(inputDate){var start=inputDate.getDate()-inputDate.getDay(),weekStartLocal=new Date(inputDate.setDate(start)),weekStartDay=weekStartLocal.getDate(),weekStartMonth=weekStartLocal.getMonth(),weekStartYear=weekStartLocal.getFullYear(),weekStart=new Date(weekStartYear,weekStartMonth,weekStartDay);return weekStart},_validateDate:function(selectedIteration,chosenDate){var me=this,maxDate=selectedIteration.get("EndDate"),minDate=selectedIteration.get("StartDate"),maxDateString=me._dateToISOString(maxDate),minDateString=me._dateToISOString(minDate),weekStartChosenDate=me._calculateWeekStart(chosenDate),warnLabel="Week Start for Chosen Date must be within Iteration StartDate: \n"+minDateString+"\nAnd EndDate:\n"+maxDateString+"\n Of Selected Tasks.";if(weekStartChosenDate.getTime()<minDate.getTime()||weekStartChosenDate.getTime()>maxDate.getTime())Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Warning: Invalid Date Selected!",message:warnLabel,confirmLabel:"Ok"});else{var confirmLabel="Add To Timesheet?",message="Add Selected Tasks to Timesheet for selected Week?";Ext.create("Rally.ui.dialog.ConfirmDialog",{message:message,confirmLabel:confirmLabel,listeners:{confirm:function(){me.onBeforeAction(me.records)!==!1&&(args={},me.saveRecords(me.records,args,chosenDate))}}})}},_selectWeekForTimesheet:function(selectedIteration){var me=this,maxDate=selectedIteration.get("EndDate"),minDate=selectedIteration.get("StartDate");me._selectDateChooserDialog&&me._selectDateChooserDialog.destroy();var label="Choose Date within Timesheet Week to Add Tasks:",defaultDate=new Date,confirmLabel="Ok";me._selectDateChooserDialog=Ext.create("ChooseDateDialog",{calendarLabel:label,defaultDate:defaultDate,confirmLabel:confirmLabel,maxDate:maxDate,minDate:minDate,listeners:{confirm:function(dialog,chosendate){me._validateDate(selectedIteration,chosendate)}}})},_hydrateIteration:function(){var me=this,selectedIteration=me.records[0].get("Iteration"),iterationOid=selectedIteration.ObjectID,iterationModel=Rally.data.ModelFactory.getModel({type:"iteration",scope:me,success:function(model,operation){model.load(iterationOid,{scope:me,success:function(iterationHydrated,operation){me._selectWeekForTimesheet(iterationHydrated)}})}})},_onAddToTimesheetClicked:function(){var me=this;me._hydrateIteration()},_dateToISOString:function(date,convertToUTC,stripTimePortion){return stripTimePortion?Rally.util.DateTime.toIsoString(date,convertToUTC).replace(/T[\W\w]*/,""):Rally.util.DateTime.toIsoString(date,convertToUTC)},onSuccess:function(successfulRecords,unsuccessfulRecords,selectedState,errorMessage){var message=["Timesheets added for",successfulRecords.length,1===successfulRecords.length?"item":"items"].join(" ");successfulRecords.length===this.records.length?Rally.ui.notify.Notifier.show({message:message+"."}):Rally.ui.notify.Notifier.showWarning({message:[message,", but ",unsuccessfulRecords.length," failed: ",errorMessage].join(" ")});var changes={};Ext.callback(this.onActionComplete,null,[successfulRecords,unsuccessfulRecords,changes]),this.records=null}})})();
                Ext.define("ChooseDateDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.choosedate",requires:["Rally.ui.Button","Rally.ui.dialog.Dialog","Rally.ui.TextField"],clientMetrics:{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"},width:200,closable:!0,autoShow:!0,cls:"rally-confirm-dialog",title:"",message:"",confirmLabel:"Continue",cancelLabel:"Cancel",defaultDate:null,selectedDate:null,calendar:null,maxDate:null,minDate:null,items:[{xtype:"component",itemId:"confirmMsg",cls:"confirmMessage"},{xtype:"container",itemId:"calendarContainer"}],dockedItems:[{xtype:"toolbar",dock:"bottom",padding:"10",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",cls:"confirm primary small",itemId:"confirmButton",userAction:"clicked yes in dialog"},{xtype:"rallybutton",cls:"cancel secondary small",itemId:"cancelButton",ui:"link"}]}],constructor:function(config){this.callParent(arguments),this.autoCenter&&(this.scrollListener.saveScrollPosition=!0),this.defaultDate=new Date,config.defaultDate&&(this.defaultDate=config.defaultDate),this.selectedDate=this.defaultDate,config.calendarLabel&&(this.calendarLabel=config.calendarLabel),config.maxDate&&(this.maxDate=config.maxDate),config.minDate&&(this.minDate=config.minDate)},initComponent:function(){var me=this;this.callParent(arguments),this.addEvents("confirm","cancel"),this.down("#confirmButton").on("click",this._onConfirm,this),this.down("#confirmButton").setText(this.confirmLabel),this.down("#cancelButton").on("click",this._onCancel,this),this.down("#cancelButton").setText(this.cancelLabel),this.message?this.down("#confirmMsg").update(this.message):this.down("#confirmMsg").hide();var calendarLabel="Choose a date:";this.calendarLabel&&(calendarLabel=this.calendarLabel);var calendarConfig={title:calendarLabel,width:400,bodyPadding:10,renderTo:Ext.getBody(),items:[{xtype:"datepicker",handler:function(picker,date){me.selectedDate=date}}]};me.maxDate&&(calendarConfig.maxDate=this.maxDate),me.minDate&&(calendarConfig.minDate=this.minDate),this.calendar=Ext.create("Ext.panel.Panel",calendarConfig),this.down("#calendarContainer").add(this.calendar)},show:function(){this.autoCenter&&this._saveScrollPosition(),this.callParent(arguments)},close:function(){this._onCancel()},_onConfirm:function(){this.fireEvent("confirm",this,this.selectedDate),this.destroy()},_onCancel:function(){this.fireEvent("cancel",this),this.destroy()},_saveScrollPosition:function(){this.savedScrollPosition={xOffset:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,yOffset:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}}});

            Rally.launchApp('CustomApp', {
                name:"Rally-CreateTimeSheetEntries",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
