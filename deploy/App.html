<!DOCTYPE html>
<html>
<head>
    <title>Rally-CreateTimeSheetEntries</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"iterationChooser",padding:"10px",layout:"hbox"},{xtype:"container",itemId:"gridContainer",padding:"10px"}],_iterationCombobox:null,_currentUser:null,_currentProject:null,_getTasksButton:null,_typeFeature:null,_taskGrid:null,launch:function(){var me=this,currentContext=me.getContext();me._currentUser=currentContext.getUser(),me._currentProject=currentContext.getProject(),me._buildUI()},_buildUI:function(){var me=this;me._iterationCombobox=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:"350px",listeners:{scope:this,select:me._getTasks}}),me.down("#iterationChooser").add(me._iterationCombobox),me._getTasksButton=Ext.create("Rally.ui.Button",{text:"Get Tasks",handler:function(){me._getTasks()}}),me.down("#iterationChooser").add(me._getTasksButton)},_getTasks:function(){var me=this,selectedIteration=this._iterationCombobox.getValue(),selectedIterationRef=Ext.create("Rally.util.Ref",selectedIteration),selectedIterationObjectID=selectedIterationRef.getOid(),currentUserName=me._currentUser.UserName,currentProjectObjectID=me._currentProject.ObjectID;this._taskGrid&&this._taskGrid.destroy(),this._taskGrid=this.down("#gridContainer").add({xtype:"rallygrid",itemId:"rallygrid",columnCfgs:["FormattedID","Name","State"],context:this.getContext(),enableBulkEdit:!0,showRowActionsColumn:!0,storeConfig:{model:"Task",filters:[{property:"Iteration.ObjectID",operator:"=",value:selectedIterationObjectID},{property:"Project.ObjectID",operator:"=",value:currentProjectObjectID},{property:"Owner.UserName",operator:"=",value:currentUserName}]}})}});
                Ext.override(Rally.ui.menu.bulk.RecordMenu,{items:[{xtype:"rallyrecordmenuitembulkcreatetimesheetentries"}]}),Ext.override(Rally.ui.menu.bulk.MenuItem,{successfulRecordsDueToNoChange:[],successfulRecords:[],dataToUpdate:[],saveRecords:function(records,args){var me=this;me.successfulRecords=[],me.successfulRecordsDueToNoChange=[],me.dataToUpdate=[];var hydratedRecords=[],promises=[];Ext.Array.each(records,function(artifact){promises.push(me.hydrateArtifact(artifact,me))}),Deft.Promise.all(promises).then({success:function(hydratedRecords){var successfulRecords=me.prepareRecords(hydratedRecords,args);if(me.successfulRecordsDueToNoChange=successfulRecords,me.successfulRecordsDueToNoChange.length===records.length)me.onSuccess(me.successfulRecordsDueToNoChange,[],args);else{var selectedState=args,selectedStateRef=selectedState.get("_ref"),updateState="";""!==selectedStateRef&&(updateState={_ref:selectedStateRef}),me.dataToUpdate=_.difference(hydratedRecords,me.successfulRecordsDueToNoChange),Rally.data.BulkRecordUpdater.updateRecords({records:me.dataToUpdate,propertiesToUpdate:{State:updateState},success:function(failedRecords){var successfulUpdateRecords=_.difference(me.dataToUpdate,failedRecords),unsuccessfulRecords=failedRecords;me.successfulRecords=me.successfulRecordsDueToNoChange.concat(successfulUpdateRecords),0!==me.successfulRecords.length?me.onSuccess(me.successfulRecords,unsuccessfulRecords,args,"successful update"):(Rally.ui.notify.Notifier.showError({message:"No updates succeeded."}),Ext.callback(me.onActionComplete,null,[me.successfulRecords,unsuccessfulRecords]))},scope:me})}}})},hydrateArtifact:function(artifact,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,artifactType=artifact.get("_type"),artifactOid=artifact.get("ObjectID"),artifactModel=Rally.data.ModelFactory.getModel({type:artifactType,scope:me,success:function(model,operation){model.load(artifactOid,{scope:me,success:function(artifactHydrated,operation){deferred.resolve(artifactHydrated)}})}});return deferred}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("CreateTimeSheetEntries.RecordMenuItemAddToTimesheet",{extend:"Rally.ui.menu.bulk.MenuItem",alias:"widget.rallyrecordmenuitembulkcreatetimesheetentries",clientMetrics:[{beginMethod:"_onAddToTimesheetClicked",endMethod:"onSuccess",description:"bulk action complete"}],config:{text:"Add to Timesheet...",handler:function(){this._onAddToTimesheetClicked()},predicate:function(records){return _.every(records,function(record){return record.self.isArtifact()})},prepareRecords:function(records){var me=this,successfulRecords=[],curr=new Date,start=curr.getDate()-curr.getDay(),weekStartLocal=new Date(curr.setDate(start)),weekStartDay=weekStartLocal.getDate(),weekStartMonth=weekStartLocal.getMonth(),weekStartYear=weekStartLocal.getFullYear(),weekStart=new Date(weekStartYear,weekStartMonth,weekStartDay),weekStartUTC=new Date(weekStart.getTime()-6e4*weekStart.getTimezoneOffset());return _.each(records,function(record){var taskRecord=record,workProduct=record.get("WorkProduct"),workProductrefString=workProduct._ref,workProductRef=Ext.create("Rally.util.Ref",workProductrefString),workProductOID=workProductRef.getOid(),taskOID=record.get("ObjectID"),taskRef=record.get("_ref"),owner=record.get("Owner"),ownerRefString=owner._ref,ownerRef=Ext.create("Rally.util.Ref",ownerRefString),ownerOID=ownerRef.getOid(),project=record.get("Project"),projectRefString=project._ref,projectRef=Ext.create("Rally.util.Ref",projectRefString),projectOID=projectRef.getOid(),timeSheetEntry={Project:projectRefString,WorkProduct:workProductrefString,Task:taskRef,User:ownerRefString,WeekStartDate:weekStartUTC.toISOString()},newTimeSheetModel=Rally.data.ModelFactory.getModel({type:"TimeEntryItem"}).then({success:function(model){var record=Ext.create(model,timeSheetEntry);record.save(),successfulRecords.push(taskRecord)}});successfulRecords.push(record)}),successfulRecords},callingScope:this},constructor:function(config){this.mergeConfig(config),this.callParent(arguments)},_onAddToTimesheetClicked:function(){var me=this,confirmLabel="Add To Timesheet?",message="Add Selected Tasks to Timesheet for this Week?";Ext.create("Rally.ui.dialog.ConfirmDialog",{message:message,confirmLabel:confirmLabel,listeners:{confirm:function(){me.onBeforeAction(me.records)!==!1&&me.saveRecords(me.records)}}})},onSuccess:function(successfulRecords,unsuccessfulRecords,selectedState,errorMessage){var message=["Timesheets added for",successfulRecords.length,1===successfulRecords.length?"item":"items"].join(" ");successfulRecords.length===this.records.length?Rally.ui.notify.Notifier.show({message:message+"."}):Rally.ui.notify.Notifier.showWarning({message:[message,", but ",unsuccessfulRecords.length," failed: ",errorMessage].join(" ")});var changes={};Ext.callback(this.onActionComplete,null,[successfulRecords,unsuccessfulRecords,changes]),this.records=null}})})();

            Rally.launchApp('CustomApp', {
                name:"Rally-CreateTimeSheetEntries",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
